# 更复杂的光照

## 指定渲染路径

Tags 中的 `LightModel` 指定了渲染路径

| 标签名                             | 描述                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| `Always`                           | 不管使用哪种渲染路径,这个 Pass 一定会被渲染, 但是不计算光照  |
| `ForwardBase`                      | 用于**前向渲染**,这个 Pass 会计算环境光, 最重要的平行光, 逐顶点 SH 光源和 LightMaps |
| `ForwardAdd`                       | 用于**前向渲染**,这个 Pass 会计算额外的逐像素光源, 每个Pass对于一个光源 |
| `Drferred`                         | 用于**延迟渲染**,这个 Pass 会渲染到 G-Buffer 中              |
| `ShadowCaster`                     | 渲染到 ShadowMap 中                                          |
| `PrepassBase`                      | **遗留的延迟渲染**, 这个 Pass 会渲染法线和高光反射指数       |
| `PrepassFinal`                     | **遗留的延迟渲染**, 这个 Pass 会合并纹理, 光照和自发光得到最后的颜色 |
| `Vertex` `VertexLMRGBM` `VertexLM` | **用于遗留的顶点照明渲染**                                   |

## Unity 前向渲染

Unity 中有 3 种处理光照的方式:

* 逐顶点处理
* 逐像素处理
* 球谐处理

决定光源如何渲染, 是根据光源的类型和渲染模式. 渲染模式就是光源是否重要

Unity使用的判断规则如下:

* 场景中最亮的平行光总是逐像素处理
* 渲染模式被设置成 Not Important 光源, 会逐个顶点或者 SH 处理
* 渲染模式被设置成 Important 的光源会逐个像素处理
* 得到的逐像素光源小于 Quality Setting 中的逐个像素数量, 会更多的光源逐个像素处理

![image-20220718132916807](image-20220718132916807.png)

## 前向渲染中可以使用的内置光照变量

| 名称                                                         | 类型       | 描述                                                         |
| ------------------------------------------------------------ | ---------- | ------------------------------------------------------------ |
| `_LightColor0`                                               | `float4`   | 改 Pass 处理的逐像素光源的颜色                               |
| `_WorldSpaceLightPos0`                                       | `float4`   | 如果 `w != 0` 是点光源, 否则是方向光                         |
| `_LightMatrix0`                                              | `float4x4` | 光空间矩阵                                                   |
| `unity_4LightPosX0`,`unity_4LightPosY0`, `unity_4LightPosZ0` | `float4`   | 仅用于 `Base Pass` 中前四个 4 非重要的点光源在世界空间的位置 |
| `unity_4LightAtten0`                                         | `float4`   | 仅用于 `Base Pass` 存储了前 4 个非重要的点光源衰减因子       |
| `unity_LightColor`                                           | `half[4]`  | 仅用于 `Base Pass` 存储了前 4 个非重要的点光源的颜色         |

## 前向渲染中可以使用的内置光照函数

```cc
// 仅用于前向渲染中. 计算前四个点光源的光照, 它的参数是已经打包进矢量的光照数据. 分别是
float3 Shade4PointLights (
    float4 lightPosX, 
    float4 lightPosY, 
    float4 lightPosZ,
    float3 lightColor0, 
    float3 lightColor1, 
    float3 lightColor2, 
    float3 lightColor3,
    float4 lightAttenSq,
    float3 pos, 
    float3 normal
)
```

## Unity 中的延迟渲染

当使用于延迟渲染; Unity 要求我们提供两个 Pass, 第一个用于渲染 G-Buffer, 第二个

